name: Deploy to VPS with Git


# Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°:
on:
  # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² main
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/2602test_laravel
  GIT_BRANCH: origin/main
  GITHUB_USERNAME: nyosru
  GIT_REPO: 2602test_laravel.git
  DOCKER_CONTAINER: 2602test_laravel

jobs:
  sms_start:
    runs-on: ubuntu-latest
    steps:
      - name: Send deployment start notification
        uses: appleboy/telegram-action@master
        with:
          to: 360209578, phpcat
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸš€ğŸš€ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ${{ github.repository }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{ github.actor }} (${{ github.run_id }})
            ğŸ“ ${{ github.event.head_commit.message }}

  #  check_commit:
  #    runs-on: ubuntu-latest
  #    outputs:
  #      start_setup: ${{ steps.check.outputs.start_setup }}
  #    steps:
  #      - name: Check commit message for start_setup
  #        id: check
  #        run: |
  #          if [[ "${{ github.event.head_commit.message }}" == *"[start_setup+"* ]]; then
  #            echo "start_setup=true" >> $GITHUB_OUTPUT
  #          else
  #            echo "start_setup=false" >> $GITHUB_OUTPUT
  #          fi

  deploy:
    runs-on: ubuntu-latest
    #needs: [sms_start, check_commit]
    steps:
      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy code to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY_DOCKER24 }}
          script: |
            set -e  # Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
            cd ${{ env.DIR }}
            git fetch --all
            git reset --hard ${{ env.GIT_BRANCH }}
            echo "âœ… ĞšĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            docker exec ${{ env.DOCKER_CONTAINER }} composer install --no-dev --optimize-autoloader
            docker exec ${{ env.DOCKER_CONTAINER }} npm install
            docker exec ${{ env.DOCKER_CONTAINER }} npm run build

            # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan migrate --force

            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞµÑˆĞ°
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize:clear
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize


#            cp caddy/prod.Caddyfile caddy/Caddyfile
#            echo "ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Caddy..."
#            docker-compose exec -T ${{ env.DOCKER_CONTAINER }} caddy reload --config /etc/caddy/Caddyfile
#            echo "âœ…âœ… Caddy Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½ Ğ±ĞµĞ· downtime"

  #            cp docker-compose.prod.yml docker-compose.yml
  #            docker-compose down --rmi all -v
  #            docker-compose up -d --build
  #            echo "âœ…âœ… ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½"
  # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ Caddy
  #  update_laravel:
  #    runs-on: ubuntu-latest
  #    needs: [check_commit, deploy]
  #    steps:
  #      - name: Setup SSH known hosts
  #        run: |
  #          mkdir -p ~/.ssh
  #          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

  #      - name: Update Laravel application
  #        uses: appleboy/ssh-action@master
  #        with:
  #          host: ${{ env.VPS_HOST }}
  #          username: ${{ env.VPS_USERNAME }}
  #          key: ${{ secrets.SSH_PRIVATE_KEY }}
  #          script: |
  #            set -e
  #            cd ${{ env.DIR }}
  #
  #            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  #            docker exec ${{ env.DOCKER_CONTAINER }} composer install --no-dev --optimize-autoloader
  #            docker exec ${{ env.DOCKER_CONTAINER }} npm install
  #            docker exec ${{ env.DOCKER_CONTAINER }} npm run build
  #
  #            # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
  #            docker exec ${{ env.DOCKER_CONTAINER }} php artisan migrate --force
  #
  #            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞµÑˆĞ°
  #            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize:clear
  #            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize
  #
  #            # ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° (ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾)
  #            if [ "${{ needs.check_commit.outputs.start_setup }}" = 'true' ]; then
  #              echo "ğŸ”§ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ..."
  #              docker exec ${{ env.DOCKER_CONTAINER }} chmod -R 775 storage
  #              docker exec ${{ env.DOCKER_CONTAINER }} chown -R www-data:www-data storage
  #              docker exec ${{ env.DOCKER_CONTAINER }} php artisan storage:link
  #            else
  #              echo "â© ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºÑƒ"
  #            fi
  #
  #            echo "âœ… Laravel Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾"

  sms_end:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send deployment success notification
        uses: appleboy/telegram-action@master
        with:
          to: 360209578, phpcat
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ€ğŸ€ğŸ€ Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ${{ github.repository }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{ github.actor }} > ${{ github.run_id }}
            ğŸ“ ${{ github.event.head_commit.message }}
            ğŸ‰ Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹!
