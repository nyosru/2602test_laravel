name: Deploy to VPS with Git


# Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°:
on:
  # ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² main
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: 91.218.230.97
  VPS_USERNAME: root
  DIR: /home/2602test_laravel
  GIT_BRANCH: origin/main
  GITHUB_USERNAME: nyosru
  GIT_REPO: 2602test_laravel.git
  DOCKER_CONTAINER: 2602test_laravel

jobs:
  sms_start:
    runs-on: ubuntu-latest
    steps:
      - name: Send deployment start notification
        uses: appleboy/telegram-action@master
        with:
          to: 360209578, phpcat
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸš€ğŸš€ğŸš€ ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ${{ github.repository }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{ github.actor }} (${{ github.run_id }})
            ğŸ“ ${{ github.event.head_commit.message }}


  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy code to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.VPS_HOST }}
          username: ${{ env.VPS_USERNAME }}
          key: ${{ secrets.DEPLOY_KEY_DOCKER24 }}
          script: |
            set -e  # Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
            cd ${{ env.DIR }}
            git fetch --all
            git reset --hard ${{ env.GIT_BRANCH }}
            echo "âœ… ĞšĞ¾Ğ´ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½"

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            docker exec ${{ env.DOCKER_CONTAINER }} composer install --no-dev --optimize-autoloader
            docker exec ${{ env.DOCKER_CONTAINER }} npm install
            docker exec ${{ env.DOCKER_CONTAINER }} npm run build

            # ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan migrate --force

            # ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° ĞºĞµÑˆĞ°
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize:clear
            docker exec ${{ env.DOCKER_CONTAINER }} php artisan optimize

  sms_end:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Send deployment success notification
        uses: appleboy/telegram-action@master
        with:
          to: 360209578, phpcat
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            ğŸ€ğŸ€ğŸ€ Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ ${{ github.repository }}
            ğŸ‘¨ğŸ»â€ğŸ’» ${{ github.actor }} > ${{ github.run_id }}
            ğŸ“ ${{ github.event.head_commit.message }}
            ğŸ‰ Ğ’ÑĞµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹!
