<template>
    <div class="min-h-screen ">
        <div class="max-w-4xl ">

            <div v-if="!parsedData" class="">

                <form @submit.prevent="parseYandexUrl" class="space-y-2">

                <h1 class="text-xl font-bold text-gray-900 mb-6">
                    –ü–∞—Ä—Å–µ—Ä –Ø–Ω–¥–µ–∫—Å —Å—Ç—Ä–∞–Ω–∏—Ü
                </h1>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            –í–≤–µ–¥–∏—Ç–µ —Å—Å—ã–ª–∫—É –Ø–Ω–¥–µ–∫—Å–∞
                        </label>
                        <div class="relative">
                            <input
                                v-model="form.url"
                                required
                                type="url"

                                placeholder="https://yandex.ru/..."
                                class="w-full pl-12 pr-4 py-4 border border-gray-300 rounded-xl shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-lg"
                            />
                            <span class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">üîó</span>
                        </div>
                        <p v-if="urlError" class="mt-2 text-sm text-red-600">
                            {{ urlError }}
                        </p>
                    </div>
                    <button
                        type="submit"
                        :disabled="loading"
                        class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-6 rounded-xl font-semibold text-lg shadow-lg hover:from-blue-600 hover:to-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-200 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                    >
                        {{ loading ? '–ü–∞—Ä—Å–∏–º, —Ñ–∞–π–≤ —Å–µ–∫–∞–Ω–¥ –ø–ª–∏–∑ ...' : '–ü–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É' }}
                    </button>
                </form>
<br/>
<br/>
                <div class="bg-yellow-300 p-2 rounded mt-3">
                    –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –Ω–∞ 30 –º–∏–Ω—É—Ç (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –Ω–∞ –ø–æ—Ä—è–¥–æ–∫ –±—ã—Å—Ç—Ä–µ–µ)
                </div>


            </div>

            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
            <div v-else class="space-y-8">

                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">
                        –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–∞—Ä—Å–∏–Ω–≥–∞: {{ parsedUrl || '–ù–µ –Ω–∞–π–¥–µ–Ω' }}
                    </h2>
                    <button
                        @click="resetForm"
                        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                    >
                        ‚Üê –ù–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥
                    </button>
                </div>

                –ù–∞–∑—ã–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏: {{ parsedData.data.original.name || '–ù–µ –Ω–∞–π–¥–µ–Ω' }}
                <br/>

                –†–µ–π—Ç–∏–Ω–≥: {{ parsedData.data.original.rating || '–ù–µ –Ω–∞–π–¥–µ–Ω' }}
                <br/>
                <br/>

                <h2 class="font-bold text-xl">–û—Ç–∑—ã–≤—ã</h2>
                <div class="max-h-[400px] border-2 border-red-300 p-5 rounded w-full overflow-auto bg-gray-200">
<!--                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">-->
                        <div v-for="(review, index) in parsedData.data.original.reviews"
                             class="bg-white shadow-xl rounded-xl p-6 mb-3"
                        >
                            <div class="space-y-2">
                                <div>{{ review.date || '–ù–µ –Ω–∞–π–¥–µ–Ω' }}</div>
                                <div class="float-right"><strong>–û—Ü–µ–Ω–∫–∞:</strong> {{ review.rating || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ' }}</div>
                                <div><strong>{{ review.author || '--' }}</strong></div>
                                <div>{{ review.text || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ' }}</div>
                            </div>


                    </div>
                </div>


                <h2 class="font-bold text-xl">businesAspects</h2>
                <div class="max-h-[300px] border-2 border-red-300 p-3 w-full overflow-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div v-for="(item, index) in parsedData.data.original.businesAspects">
                            {{ item }}
                        </div>
                    </div>
                </div>


                <div v-if="1==2">
                    <div v-if="1==2" class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <div class="bg-white shadow-xl rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            <div class="space-y-3">
                                <div><strong>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</strong> {{ parsedData.title || '–ù–µ –Ω–∞–π–¥–µ–Ω' }}</div>
                                <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ parsedData.description || '–ù–µ –Ω–∞–π–¥–µ–Ω–æ' }}</div>
                                <div><strong>–Ø–∑—ã–∫:</strong> {{ parsedData.lang || '–ù–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω' }}</div>
                            </div>
                        </div>

                        <!-- –ú–µ—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="bg-white shadow-xl rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">–ú–µ—Ç–∞ –¥–∞–Ω–Ω—ã–µ</h3>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>–•–æ—Å—Ç:</strong> {{ parsedData.host }}</div>
                                <div><strong>–ü—É—Ç—å:</strong> {{ parsedData.path }}</div>
                                <div><strong>–ö–æ–¥–∏—Ä–æ–≤–∫–∞:</strong> {{ parsedData.charset || '–ù–µ –Ω–∞–π–¥–µ–Ω–∞' }}</div>
                                <div><strong>–¢–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞:</strong> {{ parsedData.contentType }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="parsedData.openGraph"
                         class="bg-gradient-to-r from-purple-500 to-pink-500 text-white shadow-2xl rounded-xl p-8">
                        <h3 class="text-xl font-bold mb-6">Open Graph –¥–∞–Ω–Ω—ã–µ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <div v-for="(value, key) in parsedData.openGraph" :key="key"
                                 class="bg-white/20 backdrop-blur-sm rounded-lg p-4">
                                <div class="font-medium">{{ key.replace('og:', '') }}</div>
                                <div class="text-sm mt-1 truncate">{{ value }}</div>
                            </div>
                        </div>
                    </div>
                    <div v-if="1==2" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white shadow-xl rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏
                                ({{ parsedData.links?.length || 0 }})</h3>
                            <div v-if="parsedData.links?.length" class="max-h-64 overflow-y-auto space-y-2">
                                <a
                                    v-for="(link, index) in parsedData.links.slice(0, 10)"
                                    :key="index"
                                    :href="link"
                                    target="_blank"
                                    class="block p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded text-sm truncate"
                                >
                                    {{ link }}
                                </a>
                            </div>
                            <p v-else class="text-gray-500 text-sm">–°—Å—ã–ª–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>

                        <div class="bg-white shadow-xl rounded-xl p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                                ({{ parsedData.images?.length || 0 }})</h3>
                            <div v-if="parsedData.images?.length"
                                 class="grid grid-cols-3 gap-2 max-h-64 overflow-y-auto">
                                <img
                                    v-for="(img, index) in parsedData.images.slice(0, 9)"
                                    :key="index"
                                    :src="img"
                                    :alt="`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ${index + 1}`"
                                    class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity"
                                    @click="openImage(img)"
                                />
                            </div>
                            <p v-else class="text-gray-500 text-sm">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        </div>
                    </div>
                </div>


                <h2 class="font-bold px-3 text-xl">–î–∞–Ω–Ω—ã–µ</h2>

                <div style="border:2px solid red; padding: 10px;"
                     class="max-h-[300px] border-2 border-green-300 p-3 w-full overflow-auto"
                >
                    <!--                    {{ parsedData }}-->
                    <pre>
                        {{ JSON.stringify(parsedData || '–ù–µ –Ω–∞–π–¥–µ–Ω', null, 2) }}
                    </pre>
                </div>


            </div>
        </div>
    </div>
</template>

<script setup>

import {ref} from 'vue'
import {useForm} from '@inertiajs/vue3'
import axios from 'axios'

const form = useForm({
    url: 'https://yandex.ru/maps/org/samoye_populyarnoye_kafe/1010501395/reviews/',
})

const urlError = ref('')
const loading = ref(false)
const parsedData = ref(null)
const parsedUrl = ref('')

// const parseYandexUrl = () => {
// const parseYandexUrl = async () => {
//
//     if (!form.url.includes('yandex.ru') && !form.url.includes('yandex.com')) {
//         urlError.value = '–¢–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏ —Å –Ø–Ω–¥–µ–∫—Å–∞!'
//         return
//     }
//
//     loading.value = true
//     urlError.value = ''
//
//     // form.post('/parse-yandex', {
//     //     onSuccess: (page) => {
//     //         parsedData.value = page.props.parsedData
//     //         parsedUrl.value = page.props.parsedUrl
//     //         form.reset('url')
//     //     },
//     //     onError: (errors) => {
//     //         urlError.value = errors.url || '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞'
//     //     },
//     //     onFinish: () => {
//     //         loading.value = false
//     //     }
//     // })
//
//     try {
//         // await router.post('/api/parse-yandex', {url: urlInput.value}, {
//         await router.get('/api/parse-yandex', {url: urlInput.value}, {
//             preserveState: true,
//             preserveScroll: true,
//             onSuccess: (page) => {
//                 parsedData.value = page.props.parsedData
//                 // parsedUrl —Ç–æ–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–¥–∞—Ç—å –∫–∞–∫ prop
//             },
//             onError: (errors) => {
//                 urlError.value = '–û—à–∏–±–∫–∞: ' + (errors.message || JSON.stringify(errors))
//             }
//         })
//     } catch (error) {
//         urlError.value = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞: ' + error.message
//     } finally {
//         loading.value = false
//     }


//
// const parseYandexUrl = () => {
//     form.get('/api/parse-yandex', {
//         preserveState: true,
//         preserveScroll: true,
//         onSuccess: (page) => {
//             parsedData.value = page.props.parsedData
//             parsedUrl.value = form.url
//         },
//         onError: (errors) => {
//             urlError.value = errors.url || '–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞'
//         },
//         onFinish: () => loading.value = false,
//     })
// }


const parseYandexUrl = async () => {
    if (!form.url.includes('yandex.ru') && !form.url.includes('yandex.com')) {
        urlError.value = '–¢–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏ —Å –Ø–Ω–¥–µ–∫—Å–∞!'
        return
    }

    loading.value = true
    urlError.value = ''

    try {
        const response = await axios.get('/api/parse-yandex', {
            params: {url: form.url}
        })

        parsedData.value = response.data
        parsedUrl.value = form.url
        form.reset('url')
    } catch (error) {
        if (error.response) {
            urlError.value = '–û—à–∏–±–∫–∞1: ' + error.response.data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'
        } else if (error.request) {
            urlError.value = '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞'
        } else {
            urlError.value = '–û—à–∏–±–∫–∞2: ' + error.message
        }
    } finally {
        loading.value = false
    }
}

// }

const resetForm = () => {
    parsedData.value = null
    parsedUrl.value = ''
    form.reset()
}
</script>
